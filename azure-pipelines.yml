name: iLabel-CI-CD-$(date:yyyyMMdd)$(rev:.r)

trigger:
  branches:
    include:
      - master   # master 브랜치 병합 시 Stage 서버 자동 배포

variables:
  buildConfiguration: 'Release'

stages:
# 1. 빌드 단계
- stage: Build
  displayName: "Build iLabel"
  jobs:
  - job: BuildJob
    pool:
      vmImage: 'windows-latest'
    steps:
    # NuGet 패키지 복원
    - task: DotNetCoreCLI@2
      displayName: "NuGet Restore"
      inputs:
        command: 'restore'
        projects: 'iLabel/TotalLabel.sln'

    # 솔루션 빌드
    - task: DotNetCoreCLI@2
      displayName: "Build Solution"
      inputs:
        command: 'build'
        projects: 'iLabel/TotalLabel.sln'
        arguments: '--configuration $(buildConfiguration)'

    # 프로젝트 Publish (실행 프로젝트)
    - task: DotNetCoreCLI@2
      displayName: "Publish Project"
      inputs:
        command: 'publish'
        projects: 'iLabel/TotalLabel/TotalLabel.csproj'
        arguments: '--configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)'
        zipAfterPublish: true

    # 빌드 결과물 저장 (Artifact)
    - publish: $(Build.ArtifactStagingDirectory)
      artifact: drop

# 2. 배포 단계 (Stage 서버)
- stage: DeployStage
  displayName: "Deploy iLabel to Stage"
  dependsOn: Build
  condition: succeeded()
  jobs:
  - job: DeployJob
    pool:
      vmImage: 'windows-latest'
    steps:
    - task: AzureWebApp@1
      displayName: "Deploy to Azure Web App (Stage)"
      inputs:
        azureSubscription: 'Pipeline-iLabelweb'   # 👈 Service Connection 이름
        appName: 'ilabelweb-stage'                # 👈 Stage 슬롯 이름
        package: '$(Pipeline.Workspace)/drop/**/*.zip'
