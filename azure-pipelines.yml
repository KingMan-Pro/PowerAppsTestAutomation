name: iLabel-CI-CD-$(date:yyyyMMdd)$(rev:.r)

trigger:
  branches:
    include:
      - master   # master ë¸Œëœì¹˜ ë³‘í•© ì‹œ Stage ì„œë²„ ìë™ ë°°í¬

variables:
  buildConfiguration: 'Release'

stages:
# 1. ë¹Œë“œ ë‹¨ê³„
- stage: Build
  displayName: "Build iLabel"
  jobs:
  - job: BuildJob
    pool:
      vmImage: 'windows-latest'
    steps:
    # NuGet íŒ¨í‚¤ì§€ ë³µì›
    - task: DotNetCoreCLI@2
      displayName: "NuGet Restore"
      inputs:
        command: 'restore'
        projects: 'iLabel/TotalLabel.sln'

    # ì†”ë£¨ì…˜ ë¹Œë“œ
    - task: DotNetCoreCLI@2
      displayName: "Build Solution"
      inputs:
        command: 'build'
        projects: 'iLabel/TotalLabel.sln'
        arguments: '--configuration $(buildConfiguration)'

    # í”„ë¡œì íŠ¸ Publish (ì‹¤í–‰ í”„ë¡œì íŠ¸)
    - task: DotNetCoreCLI@2
      displayName: "Publish Project"
      inputs:
        command: 'publish'
        projects: 'iLabel/TotalLabel/TotalLabel.csproj'
        arguments: '--configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)'
        zipAfterPublish: true

    # ë¹Œë“œ ê²°ê³¼ë¬¼ ì €ì¥ (Artifact)
    - publish: $(Build.ArtifactStagingDirectory)
      artifact: drop

# 2. ë°°í¬ ë‹¨ê³„ (Stage ì„œë²„)
- stage: DeployStage
  displayName: "Deploy iLabel to Stage"
  dependsOn: Build
  condition: succeeded()
  jobs:
  - job: DeployJob
    pool:
      vmImage: 'windows-latest'
    steps:
    - task: AzureWebApp@1
      displayName: "Deploy to Azure Web App (Stage)"
      inputs:
        azureSubscription: 'Pipeline-iLabelweb'   # ğŸ‘ˆ Service Connection ì´ë¦„
        appName: 'ilabelweb-stage'                # ğŸ‘ˆ Stage ìŠ¬ë¡¯ ì´ë¦„
        package: '$(Pipeline.Workspace)/drop/**/*.zip'
